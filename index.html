<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Κατάλογος Υδραυλικών – Παραγγελία</title>
  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .input { border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px; }
    .btn { border:1px solid #e5e7eb; border-radius:10px; padding:8px 12px; background:#fff; cursor:pointer; }
    .btn-primary { background:#000; color:#fff; }
    .row { padding:8px 10px; border-bottom:1px solid #f3f4f6; display:flex; gap:8px; align-items:center; justify-content:space-between; }
  </style>
</head>
<body class="p-4">
  <header class="mb-4 flex items-center justify-between">
    <h1 class="text-xl font-bold">Κατάλογος Υδραυλικών</h1>
    <div class="flex gap-2">
      <button id="exportPdfBtn" class="btn btn-primary">Λήψη PDF</button>
      <button id="sendEmailBtn" class="btn">Αποστολή Email</button>
    </div>
  </header>

  <section class="mb-3">
    <input id="searchInput" class="input w-full" placeholder="Αναζήτηση (π.χ. Βάνα, Βρύση, Σιφόνι)..." />
    <p id="status" class="text-sm mt-2 text-gray-500"></p>
  </section>

  <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Αποτελέσματα -->
    <section class="border rounded-2xl">
      <div class="px-3 py-2 flex items-center justify-between bg-gray-50 border-b rounded-t-2xl">
        <div class="text-sm text-gray-600">Αποτελέσματα: <span id="resultCount" class="font-semibold">0</span></div>
      </div>
      <div id="results" class="max-h-[70vh] overflow-auto"></div>
    </section>

    <!-- Καλάθι -->
    <aside class="space-y-4">
      <div class="border rounded-2xl p-3">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Καλάθι</h2>
          <span id="cartCount" class="text-xs bg-gray-100 rounded-full px-2 py-1">0 είδη</span>
        </div>
        <div id="cart" class="mt-2 max-h-[60vh] overflow-auto"></div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="clearCart" class="btn">Καθαρισμός</button>
          <button id="downloadCartCsv" class="btn">Λήψη CSV Καλαθιού</button>
        </div>
      </div>

      <div class="border rounded-2xl p-3">
        <h3 class="font-semibold mb-2">Στοιχεία αποστολής email</h3>
        <input id="custName" class="input w-full mb-2" placeholder="Ονοματεπώνυμο" />
        <input id="custEmail" class="input w-full mb-2" placeholder="Email παραλήπτη" />
        <textarea id="custNotes" class="input w-full" rows="3" placeholder="Σημειώσεις"></textarea>
        <p class="text-xs text-gray-500 mt-2">Απαιτείται Netlify Function + SendGrid API Key.</p>
      </div>
    </aside>
  </main>

  <footer class="mt-8 text-center text-xs text-gray-500">HEY MIR!!! • CSV → Web → PDF/Email</footer>

<script>
/* ---------------- CSV sources (με fallbacks) ---------------- */
const CSV_SOURCES = "https://raw.githubusercontent.com/Mzogler/ydravlika-order-app/refs/heads/main/ydravlika_katholiko_teras_ALL.csv";

/* ---------------- State ---------------- */
let ALL = [];         // [{Περιγραφή, Κατηγορία, _nDesc, _nCat}]
let FILTERED = [];
let CART = JSON.parse(localStorage.getItem('cart') || '[]');
const statusEl = document.getElementById('status');

/* ---------------- Normalize Greek (no tones, case-insensitive, ς→σ) ---------------- */
function norm(s){
  if(!s) return '';
  s = s.toLowerCase()
       .replace(/ά/g,'α').replace(/έ/g,'ε').replace(/ή/g,'η')
       .replace(/ί/g,'ι').replace(/ό/g,'ο').replace(/ύ/g,'υ')
       .replace(/ώ/g,'ω').replace(/ϊ|ΐ/g,'ι').replace(/ϋ|ΰ/g,'υ')
       .replace(/ς/g,'σ');
  // ασφαλές αφαίρεμα τόνων (cross-browser)
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  return s.trim();
}

/* ---------------- Safe CSV loader with fallbacks ---------------- */
function papaLoad(url){
  return new Promise((resolve, reject)=>{
    Papa.parse(url, {
      download:true, header:true, skipEmptyLines:true,
      complete: r => resolve(r.data),
      error: err => reject(err)
    });
  });
}
async function loadCsvWithFallback(){
  let lastErr=null;
  for(const baseUrl of CSV_SOURCES){
    const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") + "nocache=" + Date.now();
    try{
      statusEl.textContent = "Φόρτωση CSV από: " + baseUrl;
      const data = await papaLoad(url);
      if(Array.isArray(data) && data.length) return data;
      lastErr = new Error("Empty data from " + baseUrl);
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error("All CSV sources failed");
}

/* ---------------- Filtering ---------------- */
function applyFilters() {
  const q = norm(document.getElementById('searchInput').value.trim());
  FILTERED = ALL.filter(r => q==='' || r._nDesc.includes(q) || r._nCat.includes(q));
  renderResults();
}

/* ---------------- Render results ---------------- */
function renderResults(){
  const box=document.getElementById('results'); box.innerHTML='';
  FILTERED.forEach(r=>{
    const key=r['Περιγραφή']+'|'+r['Κατηγορία'];
    const found=CART.find(x=>x.key===key);
    const qtyVal=found?found.qty:'';
    const div=document.createElement('div');
    div.className='row';
    div.innerHTML=`
      <div class="flex-1">
        <div class="font-medium">${escapeHtml(r['Περιγραφή'])}</div>
        <div class="text-xs text-gray-500">${escapeHtml(r['Κατηγορία'])}</div>
      </div>
      <input type="number" min="0" placeholder="0" value="${qtyVal}" class="input w-20 text-right qty" />`;
    const qty=div.querySelector('.qty');
    qty.addEventListener('input',()=>syncQty(r,qty.value));
    box.appendChild(div);
  });
  document.getElementById('resultCount').textContent=FILTERED.length;
}

/* ---------------- Cart ---------------- */
function saveCart(){ localStorage.setItem('cart', JSON.stringify(CART)); renderCart(); }
function syncQty(item,val){
  const key=item['Περιγραφή']+'|'+item['Κατηγορία'];
  const n=parseInt(val,10);
  const idx=CART.findIndex(x=>x.key===key);
  if(!val||isNaN(n)||n<=0){ if(idx>=0){ CART.splice(idx,1); saveCart(); } return; }
  if(idx>=0) CART[idx].qty=n; else CART.push({key,desc:item['Περιγραφή'],cat:item['Κατηγορία'],qty:n});
  saveCart();
}
function renderCart(){
  const box=document.getElementById('cart'); box.innerHTML='';
  CART.forEach(it=>{
    const div=document.createElement('div');
    div.className='row';
    div.innerHTML=`
      <div class="flex-1">
        <div class="font-medium">${escapeHtml(it.desc)}</div>
        <div class="text-xs text-gray-500">${escapeHtml(it.cat)}</div>
      </div>
      <div class="flex items-center gap-2">
        <input type="number" min="0" value="${it.qty}" class="input w-20 text-right qty" />
        <button class="btn del">✕</button>
      </div>`;
    div.querySelector('.qty').oninput=(e)=>syncQty({ 'Περιγραφή':it.desc,'Κατηγορία':it.cat },e.target.value);
    div.querySelector('.del').onclick=()=>{ CART=CART.filter(x=>x.key!==it.key); saveCart(); renderResults(); };
    box.appendChild(div);
  });
  document.getElementById('cartCount').textContent=`${CART.length} είδη`;
}

/* ---------------- PDF (Greek font) ---------------- */
async function loadGreekFont(){
  const resp=await fetch('/fonts/NotoSans-Regular.ttf');
  if(!resp.ok) throw new Error('Font fetch failed');
  const buf=await resp.arrayBuffer();
  let binary='',bytes=new Uint8Array(buf),chunk=0x8000;
  for(let i=0;i<bytes.length;i+=chunk){binary+=String.fromCharCode.apply(null,bytes.subarray(i,i+chunk));}
  return btoa(binary);
}
async function exportPDF(){
  try{
    const { jsPDF }=window.jspdf;
    const doc=new jsPDF({unit:'pt',format:'a4'});
    const base64=await loadGreekFont();
    doc.addFileToVFS('NotoSans-Regular.ttf',base64);
    doc.addFont('NotoSans-Regular.ttf','NotoSans','normal');
    doc.setFont('NotoSans');

    const date = new Date().toLocaleString('el-GR');
    doc.setFontSize(14); doc.text('Παραγγελία Υδραυλικών',40,40);
    doc.setFontSize(10); doc.text(`Ημ/νία: ${date}`,40,58);

    const rows=CART.map((x,i)=>[i+1,x.desc,x.cat,x.qty]);
    doc.autoTable({
      startY:80,
      head:[['#','Περιγραφή','Κατηγορία','Ποσ.']],
      body:rows,
      styles:{font:'NotoSans',fontSize:9},
      headStyles:{fillColor:[0,0,0]}
    });
    doc.save('paraggelia.pdf');
  }catch(e){
    console.error(e);
    alert('Σφάλμα PDF: '+e.message+' (Έλεγξε ότι υπάρχει το /fonts/NotoSans-Regular.ttf)');
  }
}

/* ---------------- Email ---------------- */
async function sendEmail(){
  const name=document.getElementById('custName').value.trim();
  const email=document.getElementById('custEmail').value.trim();
  const notes=document.getElementById('custNotes').value.trim();
  if(!email){ alert('Συμπλήρωσε email'); return; }
  if(CART.length===0){ alert('Καλάθι άδειο'); return; }
  const payload={ customer:{name,email,notes}, items:CART };
  const res=await fetch('/.netlify/functions/sendOrder',{
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
  });
  if(res.ok) alert('Email στάλθηκε'); else alert('Αποτυχία: '+await res.text());
}

/* ---------------- Utils ---------------- */
function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------------- Init ---------------- */
document.getElementById('searchInput').oninput=applyFilters;
document.getElementById('exportPdfBtn').onclick=exportPDF;
document.getElementById('sendEmailBtn').onclick=sendEmail;
document.getElementById('clearCart').onclick=()=>{ CART=[]; saveCart(); renderResults(); };
document.getElementById('downloadCartCsv').onclick=()=>{
  if(CART.length===0){ alert('Άδειο'); return; }
  const header='Περιγραφή,Κατηγορία,Ποσότητα\n';
  const body=CART.map(x=>`"${x.desc.replaceAll('"','""')}","${x.cat.replaceAll('"','""')}",${x.qty}`).join('\n');
  const blob=new Blob(["\ufeff"+header+body],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cart.csv'; a.click();
};

/* ---------------- Auto-load CSV + robust errors ---------------- */
(async()=>{
  try{
    statusEl.textContent='Φόρτωση CSV...';
    const data=await loadCsvWithFallback();

    const sample=data && data[0] || {};
    if(!('Περιγραφή' in sample) || !('Κατηγορία' in sample)){
      throw new Error('Το CSV δεν έχει στήλες "Περιγραφή" και "Κατηγορία".');
    }

    ALL=data.map(r=>({
      'Περιγραφή': r['Περιγραφή']||'',
      'Κατηγορία': r['Κατηγορία']||'',
      _nDesc: norm(r['Περιγραφή']||''),
      _nCat:  norm(r['Κατηγορία']||'')
    }));

    statusEl.textContent=`Φορτώθηκαν ${ALL.length} γραμμές από CSV.`;
    FILTERED = ALL.slice();
    renderResults(); renderCart();
  }catch(e){
    console.error('CSV load error', e);
    statusEl.classList.add('text-red-600');
    statusEl.textContent='Αποτυχία φόρτωσης CSV! '+(e?.message||'');
    alert('Αποτυχία φόρτωσης CSV! '+(e?.message||''));
  }
})();
</script>
</body>
</html>
