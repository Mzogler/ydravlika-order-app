<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Κατάλογος Υδραυλικών – Παραγγελία (Merge 2 CSVs)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .input { border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px; }
    .btn { border:1px solid #e5e7eb; border-radius:10px; padding:8px 12px; background:#fff; cursor:pointer; }
    .btn-primary { background:#000; color:#fff; }
    .row { padding:8px 10px; border-bottom:1px solid #f3f4f6; display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .badge { font-size: 11px; background:#f3f4f6; border-radius:999px; padding:2px 8px; }
  </style>
</head>
<body class="p-4">
  <header class="mb-4 flex items-center justify-between">
    <h1 class="text-xl font-bold">Κατάλογος Υδραυλικών</h1>
    <div class="flex gap-2">
      <button id="exportPdfBtn" class="btn btn-primary">Λήψη PDF</button>
    </div>
  </header>

  <section class="mb-3 grid grid-cols-1 md:grid-cols-3 gap-3">
    <div class="md:col-span-2">
      <input id="searchInput" class="input w-full" placeholder="Αναζήτηση" />
      <p id="status" class="text-sm mt-2 text-gray-500"></p>
    </div>
    <div class="flex items-center gap-2 justify-end">
      <button id="prevPage" class="btn">« Προηγ.</button>
      <span id="pageInfo" class="badge">0 / 0</span>
      <button id="nextPage" class="btn">Επόμ. »</button>
    </div>
  </section>

  <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Αποτελέσματα -->
    <section class="border rounded-2xl">
      <div class="px-3 py-2 flex items-center justify-between bg-gray-50 border-b rounded-t-2xl">
        <div class="text-sm text-gray-600">Αποτελέσματα: <span id="resultCount" class="font-semibold">0</span></div>
        <div class="text-xs text-gray-500">Εμφάνιση: <span class="badge">200/σελίδα</span></div>
      </div>
      <div id="results" class="max-h-[70vh] overflow-auto"></div>
    </section>

    <!-- Καλάθι -->
    <aside class="space-y-4">
      <div class="border rounded-2xl p-3">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Καλάθι</h2>
          <span id="cartCount" class="text-xs bg-gray-100 rounded-full px-2 py-1">0 είδη</span>
        </div>
        <div id="cart" class="mt-2 max-h-[60vh] overflow-auto"></div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="clearCart" class="btn">Καθαρισμός</button>
          <button id="downloadCartCsv" class="btn">Λήψη CSV Καλαθιού</button>
        </div>
      </div>
    </aside>
  </main>

  <footer class="mt-8 text-center text-xs text-gray-500">George Toliakis</footer>

<script>
/* ---------- CSV GROUPS (φορτώνουμε ΚΑΙ τα δύο) ---------- */
// ΟΜΑΔΑ Α: νέο extra (Κωδικός,Όνομα)
const SOURCES_EXTRA = [
  "netlify/functions/data/ydravlika_katholiko_teras_all_extra.csv"
  // μπορείς να προσθέσεις και raw GitHub mirror εδώ αν θέλεις
];
// ΟΜΑΔΑ Β: παλιό καθολικό (Περιγραφή,Κατηγορία)
const SOURCES_MAIN = [
  "netlify/functions/data/ydravlika_katholiko_teras_ALL.csv",
  "https://raw.githubusercontent.com/Mzogler/ydravlika-order-app/main/ydravlika_katholiko_teras_ALL.csv",
  "https://cdn.jsdelivr.net/gh/Mzogler/ydravlika-order-app@main/ydravlika_katholiko_teras_ALL.csv"
];

/* ---------- STATE ---------- */
let ALL = [];           // [{primary, secondary, _nPrimary, _nSecondary, schema}]
let FILTERED = [];
let CART = JSON.parse(localStorage.getItem('cart') || '[]');
let PAGE = 1;
const PAGE_SIZE = 200;

const statusEl  = document.getElementById('status');
const resultsEl = document.getElementById('results');
const resultCountEl = document.getElementById('resultCount');
const pageInfoEl = document.getElementById('pageInfo');

/* ---------- Labels (συνεπείς για μεικτά schemas) ---------- */
// Χρησιμοποιούμε κοινές ετικέτες για να «χωρέσουν» και τα δύο σχήματα:
const PRIMARY_LABEL  = "Περιγραφή / Όνομα";
const SECONDARY_LABEL= "Κατηγορία / Κωδικός";

/* ---------- Normalize (χωρίς τόνους/κεφαλαία, ς→σ) ---------- */
function norm(s){
  if(!s) return '';
  s = s.replace(/^\ufeff/, '');
  s = s.toLowerCase()
       .replace(/ά/g,'α').replace(/έ/g,'ε').replace(/ή/g,'η')
       .replace(/ί/g,'ι').replace(/ό/g,'ο').replace(/ύ/g,'υ')
       .replace(/ώ/g,'ω').replace(/ϊ|ΐ/g,'ι').replace(/ϋ|ΰ/g,'υ')
       .replace(/ς/g,'σ');
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  return s.trim();
}

/* ---------- Fetch CSV text (timeout + sanity) ---------- */
async function fetchText(url, timeoutMs=12000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const bust = url + (url.includes('?') ? '&' : '?') + 'nocache=' + Date.now();
    const resp = await fetch(bust, { signal: ctrl.signal, credentials: 'same-origin' });
    if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();
    if(!/[\n\r].+[,;].+/.test(text)) throw new Error('Not CSV content (maybe HTML/empty)');
    return text;
  } finally { clearTimeout(t); }
}

/* ---------- Parse CSV string (Papa worker) ---------- */
function parseCsvString(csvText){
  return new Promise((resolve,reject)=>{
    Papa.parse(csvText, { header:true, skipEmptyLines:true, worker:true,
      complete: r => resolve({rows:r.data, fields:r.meta.fields||[]}),
      error: e => reject(e)
    });
  });
}

/* ---------- Detect schema of a CSV file ---------- */
function detectSchema(fields){
  // 1) Ακριβές Κωδικός/Όνομα
  if (fields.includes('Κωδικός') && fields.includes('Όνομα')){
    return { type:'CODE_NAME', primaryKey:'Όνομα', secondaryKey:'Κωδικός' };
  }
  // 2) Ακριβές Περιγραφή/Κατηγορία
  if (fields.includes('Περιγραφή') && fields.includes('Κατηγορία')){
    return { type:'DESC_CAT', primaryKey:'Περιγραφή', secondaryKey:'Κατηγορία' };
  }
  // 3) Aliases (πιο χαλαρό)
  const map = {};
  for (const k of fields){
    const nk = norm(k).replace(/[^a-zα-ω0-9]/g,'');
    map[nk] = k;
  }
  const descKey = map['περιγραφη'] || map['perigrafi'] || map['description'] || map['desc'];
  const catKey  = map['κατηγορια'] || map['katigoria'] || map['category'] || map['cat'];
  if (descKey && catKey){
    return { type:'DESC_CAT', primaryKey: descKey, secondaryKey: catKey };
  }
  const codeKey = map['κωδικος'] || map['kodikos'] || map['code'] || map['id'];
  const nameKey = map['ονομα']   || map['onoma']   || map['name'] || map['title'];
  if (codeKey && nameKey){
    return { type:'CODE_NAME', primaryKey: nameKey, secondaryKey: codeKey };
  }
  return { type:'UNKNOWN', fields };
}

/* ---------- Build entries for one CSV ---------- */
function rowsToEntries(rows, schema){
  return rows.map(r=>{
    const primary   = (r[schema.primaryKey]   ?? '').toString();
    const secondary = (r[schema.secondaryKey] ?? '').toString();
    return {
      primary, secondary,
      _nPrimary: norm(primary),
      _nSecondary: norm(secondary),
      schema: schema.type // για debug/μελλοντική χρήση
    };
  });
}

/* ---------- Load ONE list of sources (first-success) ---------- */
async function loadFirstAvailable(sources){
  for(const src of sources){
    try{
      const txt = await fetchText(src);
      const parsed = await parseCsvString(txt);
      const schema = detectSchema(parsed.fields);
      if(schema.type === 'UNKNOWN'){
        console.warn('[CSV] Unknown schema @', src, parsed.fields);
        continue;
      }
      const entries = rowsToEntries(parsed.rows, schema);
      return { entries, count: entries.length, src, schema: schema.type };
    }catch(e){
      console.warn('[CSV] fail @', src, e.message);
      continue;
    }
  }
  // κανένα source δεν πέτυχε
  return { entries: [], count: 0, src: null, schema:null };
}

/* ---------- Load BOTH groups, merge, dedupe ---------- */
async function loadBothGroups(){
  const [extra, main] = await Promise.all([
    loadFirstAvailable(SOURCES_EXTRA),
    loadFirstAvailable(SOURCES_MAIN)
  ]);

  const parts = [];
  let note = [];

  if(extra.count>0){ parts.push(extra.entries); note.push(`Extra: ${extra.count} (${extra.schema})`); }
  else{ note.push('Extra: 0 (δεν βρέθηκε)'); }

  if(main.count>0){ parts.push(main.entries); note.push(`Main: ${main.count} (${main.schema})`); }
  else{ note.push('Main: 0 (δεν βρέθηκε)'); }

  // merge
  let merged = [].concat(...parts);

  // dedupe by (primary|secondary)
  const seen = new Set();
  merged = merged.filter(x=>{
    const key = x.primary+'|'+x.secondary;
    if(seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  return { merged, note: note.join(' • ') };
}

/* ---------- Filtering (debounced) ---------- */
let debounceTimer=null;
function applyFiltersDebounced(){ clearTimeout(debounceTimer); debounceTimer=setTimeout(applyFilters, 200); }
function applyFilters(){
  const q = norm(document.getElementById('searchInput').value.trim());
  FILTERED = q==='' ? ALL : ALL.filter(r => r._nPrimary.includes(q) || r._nSecondary.includes(q));
  PAGE = 1; renderPage();
}

/* ---------- Paging / Render ---------- */
function pageCount(){ return Math.max(1, Math.ceil(FILTERED.length/PAGE_SIZE)); }
function pageSlice(){ const s=(PAGE-1)*PAGE_SIZE; return FILTERED.slice(s, s+PAGE_SIZE); }

function renderPage(){
  resultsEl.innerHTML='';
  const frag = document.createDocumentFragment();
  for(const r of pageSlice()){
    const key = r.primary+'|'+r.secondary;
    const found = CART.find(x=>x.key===key);
    const qtyVal = found ? found.qty : '';

    const div = document.createElement('div'); div.className='row';

    const left = document.createElement('div'); left.className='flex-1';
    const t = document.createElement('div'); t.className='font-medium'; t.textContent = r.primary;        // Περιγραφή/Όνομα
    const s = document.createElement('div'); s.className='text-xs text-gray-500'; s.textContent = r.secondary; // Κατηγορία/Κωδικός
    left.appendChild(t); left.appendChild(s);

    const qty = document.createElement('input');
    qty.type='number'; qty.min='0'; qty.placeholder='0'; qty.value=qtyVal; qty.className='input w-20 text-right qty';
    qty.addEventListener('input', ()=>syncQty(r, qty.value));

    div.appendChild(left); div.appendChild(qty);
    frag.appendChild(div);
  }
  resultsEl.appendChild(frag);
  resultCountEl.textContent = FILTERED.length.toLocaleString('el-GR');
  pageInfoEl.textContent = `${PAGE} / ${pageCount()}`;
}

/* ---------- Cart ---------- */
function saveCart(){ localStorage.setItem('cart', JSON.stringify(CART)); renderCart(); }
function syncQty(item,val){
  const key=item.primary+'|'+item.secondary;
  const n=parseInt(val,10);
  const idx=CART.findIndex(x=>x.key===key);
  if(!val||isNaN(n)||n<=0){ if(idx>=0){ CART.splice(idx,1); saveCart(); } return; }
  if(idx>=0) CART[idx].qty=n; else CART.push({key, primary:item.primary, secondary:item.secondary, qty:n});
  saveCart();
}
function renderCart(){
  const box=document.getElementById('cart'); box.innerHTML='';
  const frag=document.createDocumentFragment();
  for(const it of CART){
    const div=document.createElement('div'); div.className='row';

    const left=document.createElement('div'); left.className='flex-1';
    const t=document.createElement('div'); t.className='font-medium'; t.textContent=it.primary;
    const s=document.createElement('div'); s.className='text-xs text-gray-500'; s.textContent=it.secondary;
    left.appendChild(t); left.appendChild(s);

    const right=document.createElement('div'); right.className='flex items-center gap-2';
    const q=document.createElement('input'); q.type='number'; q.min='0'; q.value=it.qty; q.className='input w-20 text-right qty';
    q.oninput=(e)=>syncQty({ primary:it.primary, secondary:it.secondary }, e.target.value);
    const del=document.createElement('button'); del.className='btn del'; del.textContent='✕';
    del.onclick=()=>{ CART=CART.filter(x=>x.key!==it.key); saveCart(); renderPage(); };
    right.appendChild(q); right.appendChild(del);

    div.appendChild(left); div.appendChild(right);
    frag.appendChild(div);
  }
  box.appendChild(frag);
  document.getElementById('cartCount').textContent=`${CART.length} είδη`;
}

/* ---------- PDF (Greek font) ---------- */
async function loadGreekFont(){
  const resp=await fetch('/fonts/NotoSans-Regular.ttf');
  if(!resp.ok) throw new Error('Font fetch failed');
  const buf=await resp.arrayBuffer();
  let binary='',bytes=new Uint8Array(buf),chunk=0x8000;
  for(let i=0;i<bytes.length;i+=chunk){binary+=String.fromCharCode.apply(null,bytes.subarray(i,i+chunk));}
  return btoa(binary);
}
async function exportPDF(){
  const prev = localStorage.getItem('orderName') || 'Παραγγελία';
  const input = prompt('Όνομα παραγγελίας / Όνομα αρχείου PDF:', prev);
  if (input === null) return;
  const orderName = (input.trim() || 'Παραγγελία');
  localStorage.setItem('orderName', orderName);

  const safeName = (orderName.replace(/[\\/:*?"<>|]/g, '-').substring(0,120) || 'Paraggelia');
  const fileName = safeName.endsWith('.pdf') ? safeName : (safeName + '.pdf');

  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const base64 = await loadGreekFont();
    doc.addFileToVFS('NotoSans-Regular.ttf', base64);
    doc.addFont('NotoSans-Regular.ttf','NotoSans','normal');
    doc.setFont('NotoSans');

    const date = new Date().toLocaleString('el-GR');
    const rows = CART.map((x,i)=>[i+1,x.primary,x.secondary,x.qty]);

    doc.autoTable({
      startY: 80,
      head: [['#','Περιγραφή / Όνομα','Κατηγορία / Κωδικός','Ποσ.']],
      body: rows,
      styles: { font:'NotoSans', fontSize:9 },
      headStyles: { fillColor:[0,0,0] },
      didDrawPage: (data) => {
        const pageWidth = doc.internal.pageSize.getWidth();
        doc.setFontSize(14);
        doc.text('Παραγγελία Υδραυλικών',40,40);
        doc.setFontSize(10);
        doc.text(`Ημ/νία: ${date}`,40,58);
        // το όνομα πάνω δεξιά
        doc.text(orderName, pageWidth - 40, 40, { align: 'right' });
      },
      margin: { top: 80 }
    });

    doc.save(fileName);
  }catch(e){
    alert('Σφάλμα PDF: '+ e.message +' (έλεγξε /fonts/NotoSans-Regular.ttf)');
  }
}
document.getElementById('exportPdfBtn').onclick = exportPDF;


/* ---------- Events ---------- */
document.getElementById('searchInput').addEventListener('input', applyFiltersDebounced);
document.getElementById('prevPage').onclick=()=>{ if(PAGE>1){ PAGE--; renderPage(); } };
document.getElementById('nextPage').onclick=()=>{ const pc=Math.max(1,Math.ceil(FILTERED.length/PAGE_SIZE)); if(PAGE<pc){ PAGE++; renderPage(); } };
document.getElementById('exportPdfBtn').onclick=exportPDF;
document.getElementById('clearCart').onclick=()=>{ CART=[]; saveCart(); renderPage(); };
document.getElementById('downloadCartCsv').onclick=()=>{
  if(CART.length===0){ alert('Άδειο'); return; }
  const header='Περιγραφή / Όνομα,Κατηγορία / Κωδικός,Ποσότητα\n';
  const body=CART.map(x=>`"${(x.primary||'').replaceAll('"','""')}","${(x.secondary||'').replaceAll('"','""')}",${x.qty}`).join('\n');
  const blob=new Blob(["\ufeff"+header+body],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cart.csv'; a.click();
};

/* ---------- Boot (load BOTH) ---------- */
(async()=>{
  try{
    statusEl.textContent='Φόρτωση CSVs...';
    const { merged, note } = await loadBothGroups();
    if(merged.length===0){
      throw new Error('Δεν βρέθηκαν διαθέσιμα CSV (ούτε extra ούτε main).');
    }
    ALL = merged;
    FILTERED = ALL;
    statusEl.textContent = `Συνολικά ${ALL.length.toLocaleString('el-GR')} γραμμές.`;
    renderPage(); renderCart();
  }catch(e){
    console.error('CSV load error', e);
    statusEl.classList.add('text-red-600');
    statusEl.textContent = 'Αποτυχία φόρτωσης CSV! ' + (e?.message||'');
    alert('Αποτυχία φόρτωσης CSV! ' + (e?.message||''));
  }
})();
</script>
</body>
</html>
